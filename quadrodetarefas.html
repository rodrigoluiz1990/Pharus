<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pharus - Quadro de Tarefas</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="styles/main.css">
    <link rel="stylesheet" href="styles/sidebar.css">
    <link rel="stylesheet" href="styles/board.css">
    <link rel="stylesheet" href="styles/users.css">
</head>

<body>
    <div class="container">
        <div id="sidebar-container"></div>

        <!-- Área de Conteúdo -->
        <div class="content">
            <div class="header">
                <div class="project-title">
                    <h2>Pharus</h2>
                </div>

                <div class="project-actions">
                    <button class="action-btn">
                        <i class="fas fa-filter"></i> Filtro
                    </button>
                    <button class="action-btn">
                        <i class="fas fa-sort"></i> Ordenar
                    </button>
                    <button class="action-btn">
                        <i class="fas fa-eye-slash"></i> Ocultar
                    </button>
                    <button class="action-btn">
                        <i class="fas fa-layer-group"></i> Agrupar por
                    </button>
                </div>
            </div>

            <!-- Loading State -->
            <div id="loadingIndicator" style="display: none; text-align: center; padding: 20px;">
                <i class="fas fa-spinner fa-spin"></i> Carregando...
            </div>

            <!-- Board com Colunas (Visual Monday) -->
            <div class="board" id="taskBoard">
                <!-- Colunas serão adicionadas dinamicamente via JavaScript -->
                <div class="loading-columns">
                    <i class="fas fa-spinner fa-spin"></i> Carregando quadro...
                </div>
            </div>

            <!-- Visualização Socíus (Tabela) -->
            <div class="socious-view" id="sociousView" style="display: none;">
                <div class="socious-header">
                    <h3>Tarefas</h3>
                    <div class="socious-filters">
                        <button class="action-btn" id="addTaskSocious">
                            <i class="fas fa-plus"></i> Nova Tarefa
                        </button>
                    </div>
                </div>

                <table class="socious-table">
                    <thead>
                        <tr>
                            <th width="40px"></th>
                            <th>Tarefa</th>
                            <th>Responsável</th>
                            <th>Data Solicitação</th>
                            <th>Data Entrega</th>
                            <th>Status</th>
                            <th>Prioridade</th>
                            <th>Cliente</th>
                            <th>Tipo</th>
                            <th width="100px">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="sociousTableBody">
                        <tr>
                            <td colspan="10" style="text-align: center; padding: 20px;">
                                <i class="fas fa-spinner fa-spin"></i> Carregando tarefas...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Modal para Criar/Editar Tarefa -->
        <div class="modal-overlay" id="taskModal">
            <div class="modal">
                <div class="modal-header">
                    <h3 id="modalTitle">Nova Tarefa</h3>
                    <button class="modal-close" id="closeModal">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="taskForm">
                        <input type="hidden" id="taskId">
                        <div class="form-group">
                            <label for="taskTitle">Título *</label>
                            <input type="text" id="taskTitle" class="form-control" required>
                            <label for="taskDescription">Descrição</label>
                            <textarea id="taskDescription" class="form-control" rows="3"></textarea>
                            <label for="taskObservation">Observação</label>
                            <textarea id="taskObservation" class="form-control" rows="2"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="taskClient">Cliente</label>
                            <input type="text" id="taskClient" class="form-control">
                            <label for="taskAssignee">Responsável</label>
                            <select id="taskAssignee" class="form-control">
                                <option value="">Selecionar responsável</option>
                                <!-- Opções preenchidas via JS -->
                            </select>
                            <label for="taskJira">Tarefa Jira</label>
                            <input type="text" id="taskJira" class="form-control">
                            <label for="taskRequestDate">Data Solicitação</label>
                            <input type="date" id="taskRequestDate" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="taskStatus">Status</label>
                            <select id="taskStatus" class="form-control">
                                <option value="pending">Pendente</option>
                                <option value="in_progress">Em Andamento</option>
                                <option value="review">Em Teste</option>
                                <option value="completed">Concluído</option>
                            </select>
                            <label for="taskPriority">Prioridade</label>
                            <select id="taskPriority" class="form-control">
                                <option value="low">Baixa</option>
                                <option value="medium">Média</option>
                                <option value="high">Alta</option>
                            </select>
                            <label for="taskType">Tipo de Tarefa</label>
                            <select id="taskType" class="form-control">
                                <option value="task">Novo</option>
                                <option value="bug">Erro</option>
                                <option value="improvement">Melhoria</option>
                            </select>
                            <label for="taskDueDate">Data Entrega</label>
                            <input type="date" id="taskDueDate" class="form-control">
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">Salvar</button>
                            <button type="button" class="btn btn-danger" id="deleteTask">Excluir</button>
                            <button type="button" class="btn btn-secondary" id="cancelTask">Cancelar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Loading Overlay global -->
        <div id="globalLoading" class="loading-overlay">
            <div class="loading-spinner">
                <i class="fas fa-spinner fa-spin"></i>
            </div>
            <span>Carregando...</span>
        </div>

    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="scripts/supabase-config.js"></script>
    <script src="scripts/utils.js"></script>
    <script src="scripts/auth.js"></script>
    <script src="scripts/storage.js"></script>
    <script src="scripts/modal.js"></script>
    <script src="scripts/board.js"></script>
    <script src="scripts/component-loader.js"></script>
    <script src="scripts/profile-modal.js"></script>
    <script src="scripts/table-sort.js"></script>
    <script src="scripts/chat.js"></script>
    <script>
        // Inicialização da página do quadro de tarefas
        document.addEventListener("DOMContentLoaded", async () => {
            // Aguardar o supabase-config.js inicializar
            await waitForSupabaseClient();

            try {
                // Verificar se temos uma sessão válida
                const { data: { session }, error } = await window.supabaseClient.auth.getSession();

                if (error) {
                    console.error("Erro ao obter sessão:", error);
                    return;
                }

                if (session && session.user) {
                    // Usuário autenticado - inicializar a página
                    initializePage(session.user);
                } else {
                    // Não autenticado - o supabase-config.js vai redirecionar para login
                    console.log("Usuário não autenticado");
                }
            } catch (error) {
                console.error("Erro ao inicializar página:", error);
            }
        });

        // Função para aguardar o supabaseClient estar disponível
        function waitForSupabaseClient() {
            return new Promise((resolve) => {
                if (window.supabaseClient) {
                    resolve();
                } else {
                    const checkInterval = setInterval(() => {
                        if (window.supabaseClient) {
                            clearInterval(checkInterval);
                            resolve();
                        }
                    }, 100);
                }
            });
        }

        function initializePage(user) {
            // Mostrar informações do usuário
            const userNameElement = document.getElementById("userName");
            if (userNameElement && user) {
                userNameElement.textContent = user.email || 'Usuário';
            }

            // Inicializar outras funcionalidades da página aqui
            console.log("Página inicializada para o usuário:", user.email);

            // INICIALIZAR O BOARD - ESSENCIAL!
            if (typeof BoardModule !== 'undefined' && BoardModule.initBoard) {
                console.log("Inicializando BoardModule...");
                BoardModule.initBoard();
            } else {
                console.error("BoardModule não disponível");
                // Tentar recarregar após um delay se o módulo não estiver disponível
                setTimeout(() => {
                    if (typeof BoardModule !== 'undefined' && BoardModule.initBoard) {
                        BoardModule.initBoard();
                    }
                }, 500);
            }
        };

    </script>
</body>

</html>